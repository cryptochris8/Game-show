<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clueboard Game</title>
    <link rel="stylesheet" href="overlay.css?v=2">
</head>
<body>
    <!-- Landing Page -->
    <div id="landingPage" class="landing-page" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: linear-gradient(180deg, #0a0e27 0%, #1a1a2e 50%, #16213e 100%); z-index: 1000;">
        <div class="landing-content">
            <div class="landing-header">
                <h1>üéØ CLUEBOARD</h1>
                <p class="tagline">The Ultimate Trivia Experience</p>
            </div>

            <div class="game-modes">
                <div class="mode-card" id="singlePlayerCard">
                    <div class="mode-icon">ü§ñ</div>
                    <h2>Single Player</h2>
                    <p>Challenge yourself against AI opponents</p>
                    <div class="ai-selector">
                        <label>Number of AI Opponents:</label>
                        <div class="ai-buttons">
                            <button class="ai-btn" data-count="1">1</button>
                            <button class="ai-btn" data-count="2">2</button>
                            <button class="ai-btn active" data-count="3">3</button>
                            <button class="ai-btn" data-count="4">4</button>
                            <button class="ai-btn" data-count="5">5</button>
                        </div>
                    </div>
                    <button class="btn btn-success mode-btn" id="singlePlayerBtn">
                        üéÆ Start Single Player Game
                    </button>
                </div>

                <div class="mode-card" id="multiplayerCard">
                    <div class="mode-icon">üë•</div>
                    <h2>Multiplayer</h2>
                    <p>Play with friends online</p>
                    <div class="multiplayer-info">
                        <div class="player-count">Waiting for players...</div>
                        <div class="requirements">Requires 2-6 players</div>
                    </div>
                    <button class="btn btn-primary mode-btn" id="multiplayerBtn">
                        üë• Enter Multiplayer Lobby
                    </button>
                </div>
            </div>

            <div class="landing-footer">
                <div class="features">
                    <span>üé≠ AI Personalities</span>
                    <span>üèÜ Daily Doubles</span>
                    <span>üé™ Final Round</span>
                    <span>‚ö° Real-time Buzzing</span>
                </div>
                <div class="instructions">
                    Choose your game mode above to begin!
                </div>
            </div>
        </div>
    </div>

    <div id="gameContainer" class="hidden">
        <!-- Game Board -->
        <div id="board" class="board">
            <div class="board-header">
                <h1>CLUEBOARD</h1>
            </div>
            <div id="boardGrid" class="board-grid">
                <!-- Categories and clue cells will be populated by JavaScript -->
            </div>
        </div>

        <!-- Clue Modal -->
        <div id="clueModal" class="modal hidden">
            <div class="modal-content">
                <div id="clueCategory" class="clue-category"></div>
                <div id="clueValue" class="clue-value"></div>
                <div id="clueText" class="clue-text"></div>
                
                <!-- Daily Double Wager -->
                <div id="wagerSection" class="wager-section hidden">
                    <h3>DAILY DOUBLE!</h3>
                    <p>Enter your wager:</p>
                    <input type="number" id="wagerInput" min="5" max="10000" />
                    <button id="submitWager" class="btn btn-primary">Submit Wager</button>
                </div>
                
                <!-- Timer and Buzz Section -->
                <div id="buzzSection" class="buzz-section hidden">
                    <div id="timer" class="timer">10</div>
                    <div id="lockoutMsg" class="lockout-msg hidden">LOCKOUT PERIOD</div>
                    <button id="buzzBtn" class="buzz-btn" disabled>BUZZ!</button>
                </div>
                
                <!-- Answer Section -->
                <div id="answerSection" class="answer-section hidden">
                    <input type="text" id="answerInput" placeholder="What is...?" />
                    <button id="submitAnswer" class="btn btn-primary">Submit Answer</button>
                </div>
                
                <!-- Result Display -->
                <div id="resultSection" class="result-section hidden">
                    <div id="resultText" class="result-text"></div>
                    <div id="correctAnswer" class="correct-answer"></div>
                </div>
            </div>
        </div>

        <!-- Final Round Modal -->
        <div id="finalModal" class="modal hidden">
            <div class="modal-content">
                <h2>FINAL ROUND</h2>
                <div id="finalCategory" class="final-category"></div>
                
                <!-- Wager Phase -->
                <div id="finalWagerSection" class="final-wager-section">
                    <p>Enter your wager (up to your current score or $1000, whichever is higher):</p>
                    <input type="number" id="finalWagerInput" min="0" />
                    <button id="submitFinalWager" class="btn btn-primary">Submit Wager</button>
                </div>
                
                <!-- Answer Phase -->
                <div id="finalAnswerSection" class="final-answer-section hidden">
                    <div id="finalClueText" class="final-clue-text"></div>
                    <input type="text" id="finalAnswerInput" placeholder="What is...?" />
                    <button id="submitFinalAnswer" class="btn btn-primary">Submit Answer</button>
                </div>
                
                <!-- Results Phase -->
                <div id="finalResultsSection" class="final-results-section hidden">
                    <div id="finalResults" class="final-results"></div>
                </div>
            </div>
        </div>

        <!-- Score Panel -->
        <div id="scorePanel" class="score-panel">
            <h3>SCORES</h3>
            <div id="playerScores" class="player-scores">
                <!-- Player scores will be populated here -->
            </div>
        </div>

        <!-- Game Status -->
        <div id="statusPanel" class="status-panel">
            <div id="gamePhase" class="game-phase">LOBBY</div>
            <div id="hostMsg" class="host-msg">Waiting for players to join...</div>
            <div id="currentPicker" class="current-picker hidden">Current Picker: <span id="pickerName"></span></div>

            <!-- Single Player Mode Selector -->
            <div id="singlePlayerPanel" class="single-player-panel">
                <h3>üéÆ Single Player Mode</h3>
                <div class="mode-selector">
                    <button id="singlePlayerBtn" class="btn btn-success single-player-btn">
                        ü§ñ Play vs AI (3 opponents)
                    </button>
                    <div class="ai-options">
                        <button id="aiOption1" class="btn btn-outline ai-option" data-count="1">1 AI</button>
                        <button id="aiOption3" class="btn btn-outline ai-option active" data-count="3">3 AI</button>
                        <button id="aiOption5" class="btn btn-outline ai-option" data-count="5">5 AI</button>
                    </div>
                </div>
                <div id="singlePlayerStatus" class="single-player-status"></div>
            </div>
        </div>

        <!-- Mobile Controls -->
        <div id="mobileControls" class="mobile-controls">
            <button id="mobileBuzzBtn" class="mobile-buzz-btn" disabled>BUZZ!</button>
        </div>
    </div>

    <script>
        // HYTOPIA UI Communication
        let gameState = {
            phase: 'LOBBY',
            players: [],
            board: null,
            usedCells: [],
            currentPickerId: null,
            currentClue: null,
            lockoutUntil: 0,
            buzzWindowEnd: 0,
            message: 'Waiting for players to join...',
            round: 1,
            timeRemaining: 0
        };
        let playerId = null;

        // Listen for data from server
        hytopia.onData(data => {
            console.log('Received data:', data);
            
            switch(data.type) {
                case 'GAME_STATE':
                    handleGameState(data.payload);
                    break;
                case 'CLUE_REVEAL':
                    handleClueReveal(data.payload);
                    break;
                case 'BUZZ_RESULT':
                    handleBuzzResult(data.payload);
                    break;
                case 'ANSWER_RESULT':
                    handleAnswerResult(data.payload);
                    break;
                case 'FINAL_ROUND':
                    handleFinalRound(data.payload);
                    break;
                case 'PLAYER_ID':
                    playerId = data.payload;
                    break;
                default:
                    console.log('Unknown data type:', data.type);
            }
        });

        // Game State Management
        function handleGameState(state) {
            gameState = state;
            updateUI();
        }

        function updateUI() {
            if (!gameState) return;

            // Update game phase
            document.getElementById('gamePhase').textContent = gameState.phase;
            document.getElementById('hostMsg').textContent = gameState.message || '';

            // Handle landing page vs game container visibility
            const landingPage = document.getElementById('landingPage');
            const gameContainer = document.getElementById('gameContainer');
            const humanPlayers = (gameState.players || []).filter(p => !p.id.startsWith('ai_'));

            if (gameState.phase === 'LOBBY' && humanPlayers.length <= 1) {
                // Show landing page when in lobby with 0-1 human players
                if (landingPage.classList.contains('hidden')) {
                    showLandingPage();
                }
            } else {
                // Show game container when game is active or multiple players
                if (gameContainer.classList.contains('hidden')) {
                    showGameContainer();
                }
            }

            // Update current picker
            const pickerEl = document.getElementById('currentPicker');
            if (gameState.currentPickerId && gameState.players) {
                const picker = gameState.players.find(p => p.id === gameState.currentPickerId);
                document.getElementById('pickerName').textContent = picker?.name || 'Unknown';
                pickerEl.classList.remove('hidden');
            } else {
                pickerEl.classList.add('hidden');
            }

            // Update board
            updateBoard();
            
            // Update scores
            updateScores();
        }

        function updateBoard() {
            if (!gameState.board) return;
            
            const boardGrid = document.getElementById('boardGrid');
            boardGrid.innerHTML = '';
            
            // Create category headers
            const headerRow = document.createElement('div');
            headerRow.className = 'board-row header-row';
            gameState.board.categories.forEach(category => {
                const categoryCell = document.createElement('div');
                categoryCell.className = 'category-cell';
                categoryCell.textContent = category.name;
                headerRow.appendChild(categoryCell);
            });
            boardGrid.appendChild(headerRow);
            
            // Create clue rows
            for (let row = 0; row < 5; row++) {
                const clueRow = document.createElement('div');
                clueRow.className = 'board-row';
                
                for (let col = 0; col < 6; col++) {
                    const clueCell = document.createElement('div');
                    clueCell.className = 'clue-cell';
                    
                    const cellKey = `${col}-${row}`;
                    const clue = gameState.board.categories[col].clues[row];
                    
                    if (gameState.usedCells.includes(cellKey)) {
                        clueCell.classList.add('used');
                        clueCell.textContent = '';
                    } else {
                        clueCell.textContent = `$${clue.value}`;
                        clueCell.addEventListener('click', () => selectCell(col, row));
                        
                        // Check if this is a daily double
                        const isDailyDouble = gameState.board.dailyDoubles?.some(dd => 
                            dd.category === col && dd.index === row
                        );
                        if (isDailyDouble) {
                            clueCell.classList.add('daily-double');
                        }
                    }
                    
                    clueRow.appendChild(clueCell);
                }
                boardGrid.appendChild(clueRow);
            }
        }

        function updateScores() {
            const scoresContainer = document.getElementById('playerScores');
            scoresContainer.innerHTML = '';
            
            if (gameState.players) {
                gameState.players.forEach(player => {
                    const playerScore = document.createElement('div');
                    playerScore.className = 'player-score';
                    if (player.id === gameState.currentPickerId) {
                        playerScore.classList.add('current-picker');
                    }
                    
                    playerScore.innerHTML = `
                        <div class="player-name">${player.name}</div>
                        <div class="player-score-value">$${player.score || 0}</div>
                    `;
                    scoresContainer.appendChild(playerScore);
                });
            }
        }

        // Game Actions
        function selectCell(category, index) {
            // Only allow current picker or host to select cells
            if (gameState.currentPickerId && gameState.currentPickerId !== playerId) {
                return;
            }
            
            hytopia.sendData({
                type: 'SELECT_CELL',
                payload: { category, index }
            });
        }

        function handleClueReveal(clue) {
            const modal = document.getElementById('clueModal');
            document.getElementById('clueCategory').textContent = clue.category;
            document.getElementById('clueValue').textContent = `$${clue.value}`;
            document.getElementById('clueText').textContent = clue.text;
            
            // Show appropriate sections based on clue type
            if (clue.isDailyDouble && clue.pickerId === playerId) {
                showWagerSection(clue.maxWager);
            } else {
                showBuzzSection();
            }
            
            modal.classList.remove('hidden');
        }

        function showWagerSection(maxWager) {
            document.getElementById('wagerInput').max = maxWager;
            document.getElementById('wagerSection').classList.remove('hidden');
            document.getElementById('buzzSection').classList.add('hidden');
            document.getElementById('answerSection').classList.add('hidden');
        }

        function showBuzzSection() {
            document.getElementById('wagerSection').classList.add('hidden');
            document.getElementById('buzzSection').classList.remove('hidden');
            document.getElementById('answerSection').classList.add('hidden');
            
            // Start timer display
            startTimer();
        }

        function showAnswerSection() {
            document.getElementById('buzzSection').classList.add('hidden');
            document.getElementById('answerSection').classList.remove('hidden');
            document.getElementById('answerInput').focus();
        }

        function startTimer() {
            let timeLeft = 10;
            const timerEl = document.getElementById('timer');
            const buzzBtn = document.getElementById('buzzBtn');
            const mobileBuzzBtn = document.getElementById('mobileBuzzBtn');
            
            // Show lockout initially
            document.getElementById('lockoutMsg').classList.remove('hidden');
            buzzBtn.disabled = true;
            mobileBuzzBtn.disabled = true;
            
            // Remove lockout after 300ms
            setTimeout(() => {
                document.getElementById('lockoutMsg').classList.add('hidden');
                buzzBtn.disabled = false;
                mobileBuzzBtn.disabled = false;
            }, 300);
            
            const interval = setInterval(() => {
                timeLeft--;
                timerEl.textContent = timeLeft;
                
                if (timeLeft <= 0) {
                    clearInterval(interval);
                    buzzBtn.disabled = true;
                    mobileBuzzBtn.disabled = true;
                }
            }, 1000);
        }

        // Event Listeners
        document.getElementById('buzzBtn').addEventListener('click', buzz);
        document.getElementById('mobileBuzzBtn').addEventListener('click', buzz);

        // Landing Page Event Listeners
        let selectedAICount = 3;
        const landingPage = document.getElementById('landingPage');
        const gameContainer = document.getElementById('gameContainer');

        // AI opponent count selection
        const aiBtns = document.querySelectorAll('.ai-btn');
        aiBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                // Remove active class from all buttons
                aiBtns.forEach(b => b.classList.remove('active'));
                // Add active class to clicked button
                btn.classList.add('active');
                selectedAICount = parseInt(btn.dataset.count);
            });
        });

        // Single Player Mode Button
        const singlePlayerBtn = document.getElementById('singlePlayerBtn');
        singlePlayerBtn.addEventListener('click', () => {
            // Show loading state
            singlePlayerBtn.disabled = true;
            singlePlayerBtn.textContent = '‚è≥ Starting Single Player Game...';

            // Send single player mode activation to server
            hytopia.sendData({
                type: 'SINGLE_PLAYER_ACTIVATE',
                payload: {
                    aiCount: selectedAICount
                }
            });

            // Transition to game after a short delay
            setTimeout(() => {
                showGameContainer();
            }, 1500);
        });

        // Multiplayer Mode Button
        const multiplayerBtn = document.getElementById('multiplayerBtn');
        multiplayerBtn.addEventListener('click', () => {
            // Show loading state
            multiplayerBtn.disabled = true;
            multiplayerBtn.textContent = '‚è≥ Entering Multiplayer Lobby...';

            // For multiplayer, we just show the game container
            // The server will handle player management
            setTimeout(() => {
                showGameContainer();
            }, 1000);
        });

        function showGameContainer() {
            // Hide landing page with animation
            landingPage.style.animation = 'fadeOut 0.5s ease-out';
            setTimeout(() => {
                landingPage.classList.add('hidden');
                gameContainer.classList.remove('hidden');
                gameContainer.style.animation = 'fadeIn 0.5s ease-in';
            }, 500);
        }

        function showLandingPage() {
            // Hide game container and show landing page
            gameContainer.classList.add('hidden');
            landingPage.classList.remove('hidden');
            landingPage.style.animation = 'fadeIn 0.5s ease-in';

            // Reset button states
            singlePlayerBtn.disabled = false;
            singlePlayerBtn.textContent = 'üéÆ Start Single Player Game';
            multiplayerBtn.disabled = false;
            multiplayerBtn.textContent = 'üë• Enter Multiplayer Lobby';
        }

        // Legacy single player panel references (can be removed if not needed)
        // These are kept for backwards compatibility in case they're referenced elsewhere
        
        document.getElementById('submitWager').addEventListener('click', () => {
            const wager = parseInt(document.getElementById('wagerInput').value);
            hytopia.sendData({
                type: 'DAILY_DOUBLE_WAGER',
                payload: { wager }
            });
        });
        
        document.getElementById('submitAnswer').addEventListener('click', () => {
            const answer = document.getElementById('answerInput').value;
            hytopia.sendData({
                type: 'ANSWER_SUBMIT',
                payload: { answer }
            });
        });
        
        document.getElementById('answerInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('submitAnswer').click();
            }
        });

        function buzz() {
            hytopia.sendData({
                type: 'BUZZ',
                payload: { timestamp: Date.now() }
            });
        }

        function handleBuzzResult(result) {
            if (result.winnerId === playerId) {
                showAnswerSection();
            }
        }

        function handleAnswerResult(result) {
            const resultSection = document.getElementById('resultSection');
            const resultText = document.getElementById('resultText');
            const correctAnswer = document.getElementById('correctAnswer');
            
            resultText.textContent = result.correct ? 'CORRECT!' : 'INCORRECT';
            resultText.className = `result-text ${result.correct ? 'correct' : 'incorrect'}`;
            
            if (!result.correct) {
                correctAnswer.textContent = `Correct answer: ${result.correctAnswer}`;
                correctAnswer.classList.remove('hidden');
            } else {
                correctAnswer.classList.add('hidden');
            }
            
            resultSection.classList.remove('hidden');
            
            // Hide modal after showing result
            setTimeout(() => {
                document.getElementById('clueModal').classList.add('hidden');
                resetModalSections();
            }, 3000);
        }

        function resetModalSections() {
            document.getElementById('wagerSection').classList.add('hidden');
            document.getElementById('buzzSection').classList.add('hidden');
            document.getElementById('answerSection').classList.add('hidden');
            document.getElementById('resultSection').classList.add('hidden');
            document.getElementById('answerInput').value = '';
        }

        function handleFinalRound(data) {
            const modal = document.getElementById('finalModal');
            document.getElementById('finalCategory').textContent = data.category;
            
            if (data.phase === 'wager') {
                document.getElementById('finalWagerInput').max = data.maxWager;
                document.getElementById('finalWagerSection').classList.remove('hidden');
                document.getElementById('finalAnswerSection').classList.add('hidden');
                document.getElementById('finalResultsSection').classList.add('hidden');
            } else if (data.phase === 'answer') {
                document.getElementById('finalClueText').textContent = data.clue;
                document.getElementById('finalWagerSection').classList.add('hidden');
                document.getElementById('finalAnswerSection').classList.remove('hidden');
                document.getElementById('finalResultsSection').classList.add('hidden');
            } else if (data.phase === 'results') {
                document.getElementById('finalResults').innerHTML = data.results;
                document.getElementById('finalWagerSection').classList.add('hidden');
                document.getElementById('finalAnswerSection').classList.add('hidden');
                document.getElementById('finalResultsSection').classList.remove('hidden');
            }
            
            modal.classList.remove('hidden');
        }

        // Final Round Event Listeners
        document.getElementById('submitFinalWager').addEventListener('click', () => {
            const wager = parseInt(document.getElementById('finalWagerInput').value);
            hytopia.sendData({
                type: 'FINAL_WAGER',
                payload: { wager }
            });
        });
        
        document.getElementById('submitFinalAnswer').addEventListener('click', () => {
            const answer = document.getElementById('finalAnswerInput').value;
            hytopia.sendData({
                type: 'FINAL_ANSWER',
                payload: { answer }
            });
        });
        
        document.getElementById('finalAnswerInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('submitFinalAnswer').click();
            }
        });

        // Mobile detection and responsive handling
        function isMobile() {
            return window.innerWidth <= 768;
        }

        function updateMobileLayout() {
            const gameContainer = document.getElementById('gameContainer');
            if (isMobile()) {
                gameContainer.classList.add('mobile-layout');
            } else {
                gameContainer.classList.remove('mobile-layout');
            }
        }

        window.addEventListener('resize', updateMobileLayout);
        updateMobileLayout();

        // Initialize UI with default state
        updateUI();
    </script>
</body>
</html>